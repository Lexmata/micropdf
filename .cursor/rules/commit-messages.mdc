# Commit Messages - Linus Torvalds Style

Write commit messages as if Linus Torvalds himself will be reviewing them. This means clear, concise, and professionally written messages that explain both WHAT changed and WHY.

## The Golden Rules

### 1. Subject Line (First Line)

- **50 characters or less** - Hard limit, no exceptions
- **Imperative mood** - "Add feature" not "Added feature" or "Adds feature"
- **No period at the end**
- **Capitalize the first word**
- **Be specific** - "Fix null pointer in buffer resize" not "Fix bug"

### 2. Blank Line

Always separate subject from body with a blank line. Tools like `git log --oneline` depend on this.

### 3. Body (Wrap at 72 Characters)

Explain:
- **WHAT** the change does (the subject already hints at this)
- **WHY** the change is necessary (this is the important part)
- **HOW** it achieves the goal (if not obvious from the diff)

Do NOT explain:
- How to use git
- What the diff shows (reviewers can read code)
- Obvious things

## What Linus Hates

### ❌ Terrible Commit Messages

```
fix stuff
```

```
WIP
```

```
update code
```

```
Fixed the bug where the thing didn't work properly when you did the other thing
```

```
Refactoring
```

```
misc changes
```

```
PR feedback
```

### ❌ Overly Long Subject Lines

```
Add a new feature to handle the edge case where users might want to do something specific with their data
```

### ❌ Missing Context

```
Fix crash

The app was crashing so I fixed it.
```

### ❌ Commit Messages That Describe the Diff

```
Change line 42 from foo to bar

Changed the variable name on line 42.
```

## What Linus Appreciates

### ✅ Clear and Concise

```
mm: fix page fault handling for shared mappings

When a shared mapping is accessed and the page is not present, we need
to check if another process has already faulted in the page before
attempting to allocate a new one.

The previous code would unconditionally allocate, leading to wasted
memory when racing with another process.

Fixes: abc123def456 ("mm: add shared mapping support")
Reported-by: John Doe <john@example.com>
```

### ✅ Explains the Why

```
buffer: pre-allocate on resize to reduce fragmentation

The buffer resize operation was being called frequently during PDF
parsing, causing significant memory fragmentation. By pre-allocating
25% extra capacity, we reduce the number of realloc() calls by ~80%
in typical workloads.

Benchmark results:
  Before: 1.2ms average parse time
  After:  0.9ms average parse time
```

### ✅ References Issues When Relevant

```
fix(parser): handle malformed xref tables gracefully

Some PDF generators produce xref tables with incorrect offsets.
Instead of failing hard, we now attempt recovery by scanning for
object markers.

This matches the behavior of Adobe Reader and other major PDF tools.

Closes #123
```

## Format Template

```
<type>(<scope>): <subject>

<body - wrap at 72 chars>

<footer>
```

### Types (Conventional Commits)

| Type | Description |
|------|-------------|
| `feat` | New feature |
| `fix` | Bug fix |
| `docs` | Documentation only |
| `style` | Formatting, no code change |
| `refactor` | Code restructuring |
| `perf` | Performance improvement |
| `test` | Adding/updating tests |
| `chore` | Build, config, dependencies |

### Scope

The module or area affected: `parser`, `buffer`, `ffi`, `geometry`, etc.

## Body Writing Guidelines

### Start with the Problem

```
The PDF parser would crash when encountering files with...
```

### Explain the Solution

```
This change adds validation before accessing the array, ensuring
the index is within bounds. If out of bounds, we now return an
error instead of crashing.
```

### Include Relevant Context

```
This is a common issue with PDF files generated by OldSoftware v2.x,
which incorrectly calculates object offsets.
```

### Quantify When Possible

```
Reduces memory usage by 15% for documents with many images.
Improves parsing speed by 2x for files larger than 10MB.
```

## Footer Conventions

### Referencing Issues

```
Fixes #123
Closes #456
Refs #789
```

### Breaking Changes

```
BREAKING CHANGE: The `parse()` function now returns Result<T, Error>
instead of panicking on invalid input.
```

### Co-authors

```
Co-authored-by: Jane Doe <jane@example.com>
```

## Real-World Examples

### Example 1: Bug Fix

```
fix(xref): handle generation numbers > 65535

PDF 2.0 allows generation numbers up to 2^31-1, but we were storing
them as u16. This caused truncation and incorrect object lookups
for files using high generation numbers.

Changed XrefEntry.generation from u16 to u32 to match the spec.

Fixes #234
```

### Example 2: New Feature

```
feat(filter): add Brotli decompression support

PDF 2.0 introduced Brotli as a supported compression filter.
This adds support for /BrotliDecode in content streams.

The brotli crate is used for decompression. Compression is not
yet implemented as it requires careful tuning for PDF use cases.

Performance is comparable to Flate for typical PDF content,
but significantly better for large embedded files.
```

### Example 3: Refactoring

```
refactor(buffer): simplify growth strategy

The previous growth strategy had complex heuristics that were
difficult to reason about and occasionally caused poor performance
for certain allocation patterns.

Replace with a simple doubling strategy with a maximum growth cap
of 1MB. This is simpler, predictable, and performs well across
all tested workloads.

No functional change intended.
```

### Example 4: Performance

```
perf(geometry): use SIMD for matrix multiplication

Matrix operations are a hot path during PDF rendering. This change
adds SIMD-accelerated matrix multiplication using portable_simd.

Benchmark results (matrix_concat, 1M iterations):
  Before: 847ms
  After:  312ms (2.7x faster)

Falls back to scalar implementation on platforms without SIMD.
```

## Commit Message Checklist

Before committing, verify:

- [ ] Subject is 50 chars or less
- [ ] Subject uses imperative mood
- [ ] Subject is specific (not "fix bug" or "update code")
- [ ] Body explains WHY, not just WHAT
- [ ] Body is wrapped at 72 characters
- [ ] No typos or grammatical errors
- [ ] References issues if applicable
- [ ] Breaking changes are noted

## Remember

Linus once said:

> "A commit message shows whether a developer is a good collaborator."

Your commit message is permanent. It will be read by:
- Future you (6 months from now, debugging)
- Your teammates
- Open source contributors
- Historians of the codebase

Write accordingly.
