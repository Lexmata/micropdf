name: Test Go Bindings

on:
  push:
    branches: [main, develop, 'feature/**', 'bugfix/**']
    paths:
      - 'go-micropdf/**'
      - 'micropdf-rs/src/**'
      - 'micropdf-rs/Cargo.toml'
      - '.github/workflows/test-go-bindings.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'go-micropdf/**'
      - 'micropdf-rs/src/**'
      - 'micropdf-rs/Cargo.toml'

jobs:
  test-go-docker:
    name: Test Go Bindings (Docker)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and test Go bindings
        run: |
          cd go-micropdf
          chmod +x docker/build-test.sh
          ./docker/build-test.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: go-test-results
          path: |
            go-micropdf/*.out
            go-micropdf/*.log

  test-go-native:
    name: Test Go Bindings (Native)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            micropdf-rs/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Rust library
        run: |
          cd micropdf-rs
          cargo build --release

      - name: Install Rust library
        run: |
          cd micropdf-rs
          # Use sudo -E to preserve PATH with cargo
          sudo -E env "PATH=$PATH" make install PREFIX=/usr

      - name: Test Go bindings (Mock)
        run: |
          cd go-micropdf
          CGO_ENABLED=0 go test -tags=mock -v ./...

      - name: Test Go bindings (CGO Unit Tests)
        continue-on-error: true  # CGO tests may fail if FFI is incomplete
        run: |
          cd go-micropdf
          CGO_ENABLED=1 go test -v -short ./... || echo "CGO tests skipped - some FFI functions not yet implemented"

      - name: Test Go bindings (Integration Tests)
        continue-on-error: true  # Integration tests may fail if FFI is incomplete
        run: |
          cd go-micropdf
          CGO_ENABLED=1 go test -v -tags=integration ./test/integration/... || echo "Integration tests skipped - some FFI functions not yet implemented"

      - name: Build examples
        continue-on-error: true  # CGO build may fail if FFI is incomplete
        run: |
          cd go-micropdf/example
          # Mock build (should always work)
          CGO_ENABLED=0 go build -tags=mock -o example-mock .
          # CGO build (may fail if FFI incomplete)
          CGO_ENABLED=1 go build -o example-cgo . || echo "CGO example build skipped - some FFI functions not yet implemented"

      - name: Run examples
        continue-on-error: true  # CGO run may fail if FFI is incomplete
        run: |
          cd go-micropdf/example
          # Run mock example (should always work)
          CGO_ENABLED=0 go run -tags=mock main.go
          # Run CGO example (may fail if FFI incomplete)
          CGO_ENABLED=1 go run main.go || echo "CGO example skipped - some FFI functions not yet implemented"

  test-go-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run coverage (Mock)
        run: |
          cd go-micropdf
          CGO_ENABLED=0 go test -tags=mock -coverprofile=coverage-mock.out ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./go-micropdf/coverage-mock.out
          flags: go-bindings
          name: go-micropdf

  lint-go:
    name: Lint Go Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run go fmt
        run: |
          cd go-micropdf
          gofmt -l . | tee /tmp/gofmt.out
          test ! -s /tmp/gofmt.out

      - name: Run go vet
        run: |
          cd go-micropdf
          CGO_ENABLED=0 go vet -tags=mock ./...

      - name: Run staticcheck
        uses: dominikh/staticcheck-action@v1
        with:
          version: "latest"
          working-directory: go-micropdf
          install-go: false

