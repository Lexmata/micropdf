#!/bin/sh

# Husky v9 pre-push hook
# Runs before pushing to remote

# Git LFS pre-push (if available)
if command -v git-lfs >/dev/null 2>&1; then
  git lfs pre-push "$@"
fi

# Get the current branch
branch=$(git rev-parse --abbrev-ref HEAD)

# Prevent direct push to protected branches
protected_branches="main develop"
for protected in $protected_branches; do
  if [ "$branch" = "$protected" ]; then
    echo "âš ï¸  Warning: Pushing directly to '$branch' branch."
    echo "   Consider using a feature branch and pull request instead."
  fi
done

# Run tests for changed packages
echo "ğŸ§ª Running pre-push checks..."

# Check if Rust files changed
if git diff --name-only origin/$branch...HEAD 2>/dev/null | grep -q "^nanopdf-rs/"; then
  echo "ğŸ“¦ Testing Rust package..."
  cd nanopdf-rs && cargo test --lib 2>/dev/null || {
    echo "âŒ Rust tests failed. Push aborted."
    exit 1
  }
  cd ..
fi

# Check if Node.js files changed
if git diff --name-only origin/$branch...HEAD 2>/dev/null | grep -q "^nanopdf-js/"; then
  echo "ğŸ“¦ Testing Node.js package..."
  if [ -f "nanopdf-js/package.json" ]; then
    cd nanopdf-js && pnpm test 2>/dev/null || {
      echo "âŒ Node.js tests failed. Push aborted."
      exit 1
    }
    cd ..
  fi
fi

# Check if Go files changed
if git diff --name-only origin/$branch...HEAD 2>/dev/null | grep -q "^go-nanopdf/"; then
  echo "ğŸ“¦ Testing Go package..."
  cd go-nanopdf && go test ./... 2>/dev/null || {
    echo "âŒ Go tests failed. Push aborted."
    exit 1
  }
  cd ..
fi

# Check if Python files changed
if git diff --name-only origin/$branch...HEAD 2>/dev/null | grep -q "^nanopdf-py/"; then
  echo "ğŸ“¦ Testing Python package..."
  if [ -f "nanopdf-py/pyproject.toml" ]; then
    cd nanopdf-py && python -m pytest tests/ -q 2>/dev/null || {
      echo "âŒ Python tests failed. Push aborted."
      exit 1
    }
    cd ..
  fi
fi

echo "âœ… Pre-push checks passed"
