#!/bin/sh

# Husky v9 pre-commit hook
# Runs before each commit to ensure code quality

# Check if we're in the nanopdf-rs directory and run cargo fmt check
if git diff --cached --name-only | grep -q "^nanopdf-rs/"; then
  echo "üì¶ Checking Rust formatting..."
  cd nanopdf-rs && cargo fmt --check 2>/dev/null || {
    echo "‚ùå Rust formatting check failed. Run 'cargo fmt' to fix."
    exit 1
  }
  cd ..
fi

# Check if we're in the nanopdf-js directory and run format check
if git diff --cached --name-only | grep -q "^nanopdf-js/"; then
  echo "üì¶ Checking Node.js formatting..."
  if [ -f "nanopdf-js/package.json" ] && grep -q '"format:check"' nanopdf-js/package.json 2>/dev/null; then
    cd nanopdf-js && pnpm format:check 2>/dev/null || {
      echo "‚ùå Node.js formatting check failed. Run 'pnpm format' to fix."
      exit 1
    }
    cd ..
  fi
fi

# Check if we're in the go-nanopdf directory and run go fmt check
if git diff --cached --name-only | grep -q "^go-nanopdf/"; then
  echo "üì¶ Checking Go formatting..."
  cd go-nanopdf && test -z "$(gofmt -l .)" 2>/dev/null || {
    echo "‚ùå Go formatting check failed. Run 'gofmt -w .' to fix."
    exit 1
  }
  cd ..
fi

# Check if we're in the nanopdf-py directory and run format check
if git diff --cached --name-only | grep -q "^nanopdf-py/"; then
  echo "üì¶ Checking Python formatting..."
  if command -v black >/dev/null 2>&1; then
    cd nanopdf-py && black --check src/ tests/ 2>/dev/null || {
      echo "‚ùå Python formatting check failed. Run 'black src/ tests/' to fix."
      exit 1
    }
    cd ..
  fi
fi

echo "‚úÖ Pre-commit checks passed"

