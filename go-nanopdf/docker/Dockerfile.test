# Multi-stage Dockerfile for testing go-nanopdf
# Builds the Rust library and tests Go bindings with both mock and CGO

# Stage 1: Build the Rust library
FROM rust:1.87-bookworm AS rust-builder

WORKDIR /build

# Copy Rust project
COPY nanopdf-rs/ ./nanopdf-rs/

# Build the Rust library
WORKDIR /build/nanopdf-rs
RUN cargo build --release

# Stage 2: Go testing environment
FROM golang:1.23-bookworm

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /workspace

# Copy the Rust library from builder stage
COPY --from=rust-builder /build/nanopdf-rs/target/release/libnanopdf.a /usr/local/lib/
COPY --from=rust-builder /build/nanopdf-rs/include/ /usr/local/include/

# Copy Go project
COPY go-nanopdf/ ./go-nanopdf/

# Set working directory to Go project
WORKDIR /workspace/go-nanopdf

# Create lib directories for different architectures
RUN mkdir -p lib/linux_amd64 lib/linux_arm64 && \
    cp /usr/local/lib/libnanopdf.a lib/linux_amd64/ && \
    cp /usr/local/lib/libnanopdf.a lib/linux_arm64/

# Copy headers to Go project include directory
RUN cp -r /usr/local/include/* include/

# Environment variables
ENV CGO_ENABLED=1
ENV GOFLAGS="-v"

# Default command: run all tests
CMD ["sh", "-c", "\
    echo '=====================================' && \
    echo 'Testing go-nanopdf' && \
    echo '=====================================' && \
    echo '' && \
    echo '==> Running unit tests (mock, no CGO)...' && \
    CGO_ENABLED=0 go test -tags=mock -v ./... && \
    echo '' && \
    echo '==> Running unit tests (CGO with Rust FFI)...' && \
    CGO_ENABLED=1 go test -v -short ./... && \
    echo '' && \
    echo '==> Running integration tests...' && \
    CGO_ENABLED=1 go test -v -tags=integration ./test/integration/... && \
    echo '' && \
    echo '==> Building mock example...' && \
    CGO_ENABLED=0 go build -tags=mock -o /tmp/example-mock ./example && \
    echo '' && \
    echo '==> Building CGO example...' && \
    CGO_ENABLED=1 go build -o /tmp/example-cgo ./example && \
    echo '' && \
    echo '==> Running example (mock)...' && \
    CGO_ENABLED=0 /tmp/example-mock || true && \
    echo '' && \
    echo '=====================================' && \
    echo 'All tests passed!' && \
    echo '=====================================' \
"]

